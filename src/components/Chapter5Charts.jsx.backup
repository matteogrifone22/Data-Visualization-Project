import React, { useRef, useEffect, useState } from 'react';
import * as d3 from 'd3';
import gazaBoundaries from '../GazaMap/GazaStrip_MunicipalBoundaries.json';
import incidentsData from '../Dataset/processed/Combined_Incidents_GeoChart.csv?raw';

const GeoChart = ({ isDark }) => {
    const svgRef = useRef();
    const wrapperRef = useRef();
    const [selectedType, setSelectedType] = useState('all');
    const [timeFilter, setTimeFilter] = useState('all');

    useEffect(() => {
        if (!svgRef.current || !wrapperRef.current) return;

        // Log to verify GeoJSON is loaded correctly
        console.log('Gaza boundaries:', gazaBoundaries);
        console.log('Gaza bounds:', d3.geoBounds(gazaBoundaries));
        console.log('Features count:', gazaBoundaries.features?.length);

        const incidents = d3.csvParse(incidentsData, d => ({
            ...d,
            latitude: +d.latitude,
            longitude: +d.longitude
        }));

        let filteredIncidents =
            selectedType === 'all'
                ? incidents
                : incidents.filter(d => d.type === selectedType);

        if (timeFilter !== 'all') {
            filteredIncidents = filteredIncidents.filter(
                d => d.year === timeFilter
            );
        }

        d3.select(svgRef.current).selectAll('*').remove();
        d3.selectAll('.map-tooltip').remove();

        const width =
            wrapperRef.current.getBoundingClientRect().width || 1000;
        const height = 700;
        const margin = { top: 40, right: 40, bottom: 60, left: 40 };

                const svg = d3
                    .select(svgRef.current)
                    .attr('width', width)
                    .attr('height', height);

                // PROIEZIONE CORRETTA (con margini)
                const projection = d3
                    .geoMercator()
                    .fitExtent(
                        [
                            [margin.left, margin.top],
                            [width - margin.right, height - margin.bottom]
                        ],
                        gazaBoundaries
                    );

                const pathGenerator = d3.geoPath().projection(projection);

                const g = svg.append('g');

                // CONFINI
                g.selectAll('.boundary')
                    .data(gazaBoundaries.features)
                    .enter()
                    .append('path')
                    .attr('class', 'boundary')
                    .attr('d', pathGenerator)
                    .attr(
                        'fill',
                        isDark
                            ? 'rgba(60,60,60,0.4)'
                            : 'rgba(240,240,240,0.6)'
                    )
                    .attr('stroke', isDark ? '#aaa' : '#666')
                    .attr('stroke-width', 1.5);

                const colorScale = d3
                    .scaleOrdinal()
                    .domain(['Food System', 'Health Care'])
                    .range(['#ef4444', '#3b82f6']);

                const tooltip = d3
                    .select('body')
                    .append('div')
                    .attr('class', 'map-tooltip')
                    .style('position', 'absolute')
                    .style('visibility', 'hidden')
                    .style(
                        'background-color',
                        isDark
                            ? 'rgba(30,30,30,0.95)'
                            : 'rgba(255,255,255,0.95)'
                    )
                    .style('color', isDark ? '#fff' : '#000')
                    .style('padding', '12px')
                    .style('border-radius', '6px')
                    .style('box-shadow', '0 4px 12px rgba(0,0,0,0.3)')
                    .style('font-size', '13px')
                    .style('pointer-events', 'none')
                    .style('z-index', '1000')
                    .style('max-width', '300px');

                // PUNTI INCIDENTI
                g.selectAll('.incident-point')
                    .data(filteredIncidents)
                    .enter()
                    .append('circle')
                    .attr('class', 'incident-point')
                    .attr('cx', d => projection([d.longitude, d.latitude])[0])
                    .attr('cy', d => projection([d.longitude, d.latitude])[1])
                    .attr('r', 4)
                    .attr('fill', d => colorScale(d.type))
                    .attr('fill-opacity', 0.7)
                    .attr('stroke', d => colorScale(d.type))
                    .attr('stroke-width', 1)
                    .style('cursor', 'pointer')
                    .on('mouseover', function (event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr('r', 8)
                            .attr('fill-opacity', 1)
                            .attr('stroke-width', 2);

                        tooltip
                            .style('visibility', 'visible')
                            .html(`
                                <strong>${d.type}</strong><br/>
                                <strong>Date:</strong> ${d.date_string}<br/>
                                <strong>Lat/Lon:</strong> ${d.latitude}, ${d.longitude}<br/>
                                <strong>Perpetrator:</strong> ${d.perpetrator || 'N/A'}<br/>
                                <strong>Weapon:</strong> ${d.weapon || 'N/A'}<br/>
                                <div style="margin-top:6px;font-size:12px;">
                                    ${d.description?.slice(0, 150) || ''}
                                </div>
                            `);
                    })
                    .on('mousemove', event => {
                        tooltip
                            .style('top', event.pageY - 10 + 'px')
                            .style('left', event.pageX + 10 + 'px');
                    })
                    .on('mouseout', function () {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr('r', 4)
                            .attr('fill-opacity', 0.7)
                            .attr('stroke-width', 1);

                        tooltip.style('visibility', 'hidden');
                    });

                // LEGENDA
                const legendData = [
                    { type: 'Food System', color: '#ef4444' },
                    { type: 'Health Care', color: '#3b82f6' }
                ];

                const legend = svg
                    .append('g')
                    .attr(
                        'transform',
                        `translate(${width - 180}, ${height - 80})`
                    );

                legend
                    .selectAll('g')
                    .data(legendData)
                    .enter()
                    .append('g')
                    .attr(
                        'transform',
                        (d, i) => `translate(0, ${i * 25})`
                    )
                    .each(function (d) {
                        const lg = d3.select(this);
                        lg.append('circle')
                            .attr('r', 6)
                            .attr('fill', d.color);
                        lg.append('text')
                            .attr('x', 14)
                            .attr('y', 5)
                            .style('font-size', '14px')
                            .style('fill', isDark ? '#fff' : '#000')
                            .text(d.type);
                    });

                svg.append('text')
                    .attr('x', margin.left)
                    .attr('y', height - 20)
                    .style('font-size', '14px')
                    .style('fill', isDark ? '#aaa' : '#666')
                    .text(`Total incidents: ${filteredIncidents.length}`);

    }, [isDark, selectedType, timeFilter]);

    return (
        <div ref={wrapperRef} style={{ width: '100%' }}>
            <div
                style={{
                    marginBottom: '20px',
                    display: 'flex',
                    gap: '20px',
                    flexWrap: 'wrap'
                }}
            >
                <select
                    value={selectedType}
                    onChange={e => setSelectedType(e.target.value)}
                >
                    <option value="all">All Types</option>
                    <option value="Food System">Food System</option>
                    <option value="Health Care">Health Care</option>
                </select>

                <select
                    value={timeFilter}
                    onChange={e => setTimeFilter(e.target.value)}
                >
                    <option value="all">All Years</option>
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                </select>
            </div>

            <svg ref={svgRef} style={{ width: '100%', display: 'block' }} />
        </div>
    );
};

export default GeoChart;
